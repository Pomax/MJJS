<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Mahjong implementation</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="triggers.js"></script>

    <script>
      window.on("tile-mouseover", function(evt) {
        // console.log("mouseover", evt);
        var tile = evt.tile;
        if(!tile.concealed) {
          tile.setAttribute("title", Constants.tileNames[tile.tileNumber]);
        }
      });

      window.on("tile-mouseout", function(evt) {
        // console.log("mouseout", evt);
      });

      window.on("tile-click", function(evt) {
        // console.log("click", evt);
        evt.tile.reveal();
      });
    </script>

    <script src="constants.js"></script>
    <script src="tile.js"></script>
    <script src="wall.js"></script>
    <script src="generator.js"></script>
    <script src="statistics.js"></script>
    <script src="strategies.js"></script>
    <script src="sets.js"></script>
    <script src="runs.js"></script>
    <script src="declared.js"></script>
    <script src="bank.js"></script>
    <script src="hand.js"></script>
    <script src="player.js"></script>

    <script src="turnhistory.js"></script>
    <script src="utilities.js"></script>
  </head>

  <body>
    <table><tr><td>
      <button onclick="setupGame()">Reset the game</button>
      <button onclick="autoplay()">Play game</button>
      <button onclick="interrupt = true">Interrupt</button>
    </td></tr><table>

    <table>
      <tr><td style="width: 50%; vertical-align: top;">
        <h2>The wall</h2>
        <div id="wall"></div>
      </td><td style="width: 50%; vertical-align: top;">
        <h2>The discards</h2>
        <div id="discards"></div>
      </td></tr>
    </table>

    <h2>The players</h2>
    <div id="players"></div>

    <p style="text-align:right"><a href="https://github.com/Pomax/MJJS/tree/gh-pages">This is a work in progress, code on github.com</a></p>

    <script>
      var setupGame = function setupGame() {
        // clear "board"
        document.getElementById("wall").innerHTML = "";
        document.getElementById("discards").innerHTML = "";
        document.getElementById("players").innerHTML = "";

        // set up "board"
        var wall = new Wall();
        var players = [];

        // set up the game run function
        (function runGame() {
          document.getElementById("wall").appendChild(wall.asHTMLElement());
          var discards = document.getElementById("discards");
          var playerNames = ["Pomax", "Defense Cat", "Yellow Dragon", "Tonbot5000"], pos;

          (function setupHand(playerNames) {
            playerNames.forEach(function(playerName) {
              pos = players.length;
              players.push(new Player(playerName));
              document.getElementById("players").appendChild(players[pos].asHTMLElement());
            });

            // draw tiles for each player
            for(var i=0; i < Constants.HANDSIZE - 1; i++) {
              players[0].draw(wall);
              players[1].draw(wall);
              players[2].draw(wall);
              players[3].draw(wall);
            }

            // show what each player has in their hand
            for(var i=0; i<4; i++) {
              players[i].reveal();
              players[i].sort();
            }
          }(playerNames));

          // set up the game loop function
          window.gameLoop = (function(players, wall, discardsDiv) {
            var idx = 3, i=0, tile;
            turnHistory = newHistory();

            // closure wrapped
            return function() {
              players[idx].unhighlight();
              idx = (idx+1)%4;

              var player = players[idx];
              player.highlight();
              var drawnTile = player.draw(wall);

              if (drawnTile === Constants.NOTILE) {
                console.log("Game was drawn.");
                return Constants.DRAWN;
              }

              drawnTile.reveal();
              console.log(player.name + " drew [" + Tiles.getTileName(drawnTile)+ "] from the wall");
              var discardTile = player.discard();
              console.log(player.name + " discards "+discardTile.tileNumber+" [" + Tiles.getTileName(discardTile) + "]");
              player.sort();

              if(discardTile === Constants.WIN || discardTile === Constants.NOTHING) {
                turnHistory.addStep(player, drawnTile, Constants.NOTHING, Constants.WIN);
                return Constants.WON;
              }

              turnHistory.addStep(player, drawnTile, discardTile);

              // does anyone want this?
              (function checkClaim() {
                var bestBid = -1, bid, bidx, bestBidder, bidder;
                while (bestBid != 0) {
                  bestBid = 0;
                  bestBidder = -1;
                  for(i=1; i<4; i++) {
                    bidx = (idx+i)%4;
                    bidder = players[bidx];
                    bid = bidder.lookingFor(discardTile);
                    // better than current bid?
                    if(bid > bestBid) {
                      if(i>1 && bid<Constants.PUNG) continue;
                      console.log(bidder.name + " wants this tile (bid: "+bid+", to form a "+Constants.setNames[Tiles.getClaimType(bid)]+").");
                      console.log(bidder.name + " currently holds " + bidder.hand.concealed.toTileNumbers()+", requires " + bidder.hand.strategy.required);
                      bestBid = bid;
                      bestBidder = bidx;
                    }
                  }

                  // if there is a valid bid, honour the claim
                  if (bestBid > 0) {
                    drawnTile = discardTile;
                    console.log("claim bid accepted.");
                    player.unhighlight();
                    idx = bestBidder;
                    player = players[idx];
                    player.highlight();
                    player.claim(drawnTile, bestBid);

                    // if this was for a kong, the player gets a supplement tile
                    if(bestBid === Constants.PUNG) {
                      console.log(player.name+" played a kong. Issuing supplement tile.");
                      player.draw(wall, true);
                    }
                    discardTile = player.discard();
                    if(discardTile === Constants.WIN || discardTile === Constants.NOTHING) {
                      turnHistory.addStep(player, drawnTile, Constants.NOTHING, Constants.WIN);
                      return Constants.WON;
                    }
                    player.sort();
                    turnHistory.addStep(player, drawnTile, discardTile, bestBid);
                    console.log(player.name + " discards [" + Tiles.getTileName(discardTile) + "] after claiming [" + Tiles.getTileName(drawnTile) + "]");
                  }
                }

                console.log("no one wants it.");
                discardsDiv.appendChild(discardTile);
              }());

              // successful tile
              return Constants.CONTINUE;
            }
          }(players, wall, discards));
        }());  // end of runGame()

        window.interrupt = false;

        // call this!
        window.autoplay = function() {
          if(interrupt) return;
          if(!wall.isDead()) {
            var result = gameLoop();
            if (result === Constants.WON) {
              throw "won";
            }
            if (result === Constants.DRAWN) {
              setupGame();
            }
            setTimeout(autoplay, 5);
          }
        }
      };  // end of setupGame

      setupGame();
    </script>
  </body>
</html>